<?php
/**
 * Slot Manager
 * 
 * Manages activity time slots and availability
 * 
 * @package WazaBooking\Admin
 */

namespace WazaBooking\Admin;

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}
    public function add_admin_menu() {
        add_submenu_page(
            'waza-booking',
            __('Time Slots', 'waza-booking'),
            __('Time Slots', 'waza-booking'),
            'manage_options',
            'waza-slots',
            [$this, 'admin_page']
        );
    }
    
    /**
     * Enqueue admin scripts
     */
    public function enqueue_admin_scripts($hook) {
        if ('waza_page_waza-slots' !== $hook) {
            return;
        }
        
        wp_enqueue_script('jquery');
        wp_enqueue_script('jquery-ui-datepicker');
        wp_enqueue_style('wp-jquery-ui-dialog');
        
        wp_enqueue_script(
            'waza-slot-admin',
            WAZA_BOOKING_PLUGIN_URL . 'assets/admin-slots.js',
            ['jquery', 'jquery-ui-datepicker'],
            WAZA_BOOKING_VERSION,
            true
        );
        
        wp_localize_script('waza-slot-admin', 'wazaSlots', [
            'ajaxUrl' => admin_url('admin-ajax.php'),
            'nonce' => wp_create_nonce('waza_slot_nonce'),
            'strings' => [
                'confirmDelete' => __('Are you sure you want to delete this slot?', 'waza-booking'),
                'saved' => __('Slot saved successfully!', 'waza-booking'),
                'error' => __('An error occurred. Please try again.', 'waza-booking')
            ]
        ]);
    }
    
    /**
     * Admin page
     */
    public function admin_page() {
        $current_tab = $_GET['tab'] ?? 'list';
        ?>
        <div class="wrap">
            <h1><?php esc_html_e('Time Slots Management', 'waza-booking'); ?></h1>
            
            <nav class="nav-tab-wrapper">
                <a href="<?php echo esc_url(admin_url('admin.php?page=waza-slots&tab=list')); ?>" 
                   class="nav-tab <?php echo $current_tab === 'list' ? 'nav-tab-active' : ''; ?>">
                    <?php esc_html_e('All Slots', 'waza-booking'); ?>
                </a>
                <a href="<?php echo esc_url(admin_url('admin.php?page=waza-slots&tab=add')); ?>" 
                   class="nav-tab <?php echo $current_tab === 'add' ? 'nav-tab-active' : ''; ?>">
                    <?php esc_html_e('Add Single Slot', 'waza-booking'); ?>
                </a>
                <a href="<?php echo esc_url(admin_url('admin.php?page=waza-slots&tab=bulk')); ?>" 
                   class="nav-tab <?php echo $current_tab === 'bulk' ? 'nav-tab-active' : ''; ?>">
                    <?php esc_html_e('Bulk Create', 'waza-booking'); ?>
                </a>
            </nav>
            
            <div class="tab-content">
                <?php
                switch ($current_tab) {
                    case 'add':
                        $this->render_add_slot_form();
                        break;
                    case 'bulk':
                        $this->render_bulk_create_form();
                        break;
                    default:
                        $this->render_slots_list();
                        break;
                }
                ?>
            </div>
        </div>
        <?php
    }
    
    /**
     * Render slots list
     */
    private function render_slots_list() {
        global $wpdb;
        
        // Get slots with activity details
        $slots = $wpdb->get_results("
            SELECT s.*, p.post_title as activity_title,
                   COUNT(b.id) as bookings_count,
                   SUM(CASE WHEN b.booking_status = 'confirmed' THEN b.attendees_count ELSE 0 END) as confirmed_bookings
            FROM {$wpdb->prefix}waza_slots s
            LEFT JOIN {$wpdb->posts} p ON s.activity_id = p.ID
            LEFT JOIN {$wpdb->prefix}waza_bookings b ON s.id = b.slot_id
            GROUP BY s.id
            ORDER BY s.start_datetime DESC
            LIMIT 50
        ");
        
        ?>
        <div class="waza-slots-list">
            <div class="tablenav top">
                <div class="alignleft actions">
                    <a href="<?php echo esc_url(admin_url('admin.php?page=waza-slots&tab=add')); ?>" 
                       class="button button-primary">
                        <?php esc_html_e('Add New Slot', 'waza-booking'); ?>
                    </a>
                </div>
            </div>
            
            <table class="wp-list-table widefat fixed striped">
                <thead>
                    <tr>
                        <th><?php esc_html_e('Activity', 'waza-booking'); ?></th>
                        <th><?php esc_html_e('Date & Time', 'waza-booking'); ?></th>
                        <th><?php esc_html_e('Capacity', 'waza-booking'); ?></th>
                        <th><?php esc_html_e('Bookings', 'waza-booking'); ?></th>
                        <th><?php esc_html_e('Status', 'waza-booking'); ?></th>
                        <th><?php esc_html_e('Actions', 'waza-booking'); ?></th>
                    </tr>
                </thead>
                <tbody>
                    <?php if (empty($slots)): ?>
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                <p><?php esc_html_e('No time slots found.', 'waza-booking'); ?></p>
                                <p>
                                    <a href="<?php echo esc_url(admin_url('admin.php?page=waza-slots&tab=add')); ?>" 
                                       class="button button-primary">
                                        <?php esc_html_e('Create Your First Slot', 'waza-booking'); ?>
                                    </a>
                                </p>
                            </td>
                        </tr>
                    <?php else: ?>
                        <?php foreach ($slots as $slot): ?>
                            <tr>
                                <td>
                                    <strong><?php echo esc_html($slot->activity_title ?: __('Unknown Activity', 'waza-booking')); ?></strong>
                                </td>
                                <td>
                                    <?php echo esc_html(wp_date('M j, Y @ g:i A', strtotime($slot->start_datetime))); ?>
                                    <br>
                                    <small><?php echo esc_html(wp_date('g:i A', strtotime($slot->end_datetime))); ?></small>
                                </td>
                                <td>
                                    <?php echo intval($slot->capacity); ?>
                                </td>
                                <td>
                                    <?php echo intval($slot->confirmed_bookings); ?> / <?php echo intval($slot->capacity); ?>
                                    <br>
                                    <small><?php echo intval($slot->bookings_count); ?> total</small>
                                </td>
                                <td>
                                    <span class="status-badge status-<?php echo esc_attr($slot->status); ?>">
                                        <?php echo esc_html(ucfirst($slot->status)); ?>
                                    </span>
                                </td>
                                <td>
                                    <a href="#" class="button button-small edit-slot" 
                                       data-slot-id="<?php echo esc_attr($slot->id); ?>">
                                        <?php esc_html_e('Edit', 'waza-booking'); ?>
                                    </a>
                                    <a href="#" class="button button-small button-link-delete delete-slot" 
                                       data-slot-id="<?php echo esc_attr($slot->id); ?>">
                                        <?php esc_html_e('Delete', 'waza-booking'); ?>
                                    </a>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </tbody>
            </table>
        </div>
        
        <style>
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-available { background: #d1e7dd; color: #0f5132; }
        .status-full { background: #f8d7da; color: #721c24; }
        .status-cancelled { background: #f1f3f4; color: #5f6368; }
        </style>
        <?php
    }
    
    /**
     * Render add slot form
     */
    private function render_add_slot_form() {
        // Get activities
        $activities = get_posts([
            'post_type' => 'waza_activity',
            'post_status' => 'publish',
            'numberposts' => -1
        ]);
        
        ?>
        <form id="add-slot-form" class="waza-form">
            <table class="form-table">
                <tr>
                    <th scope="row">
                        <label for="activity_id"><?php esc_html_e('Activity', 'waza-booking'); ?></label>
                    </th>
                    <td>
                        <select id="activity_id" name="activity_id" required>
                            <option value=""><?php esc_html_e('Select an activity', 'waza-booking'); ?></option>
                            <?php foreach ($activities as $activity): ?>
                                <option value="<?php echo esc_attr($activity->ID); ?>">
                                    <?php echo esc_html($activity->post_title); ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                        <?php if (empty($activities)): ?>
                            <p class="description">
                                <?php esc_html_e('No activities found. Please create an activity first.', 'waza-booking'); ?>
                                <a href="<?php echo esc_url(admin_url('post-new.php?post_type=waza_activity')); ?>">
                                    <?php esc_html_e('Create Activity', 'waza-booking'); ?>
                                </a>
                            </p>
                        <?php endif; ?>
                    </td>
                </tr>
                
                <tr>
                    <th scope="row">
                        <label for="start_date"><?php esc_html_e('Start Date', 'waza-booking'); ?></label>
                    </th>
                    <td>
                        <input type="date" id="start_date" name="start_date" required 
                               min="<?php echo esc_attr(date('Y-m-d')); ?>" />
                    </td>
                </tr>
                
                <tr>
                    <th scope="row">
                        <label for="start_time"><?php esc_html_e('Start Time', 'waza-booking'); ?></label>
                    </th>
                    <td>
                        <input type="time" id="start_time" name="start_time" required />
                    </td>
                </tr>
                
                <tr>
                    <th scope="row">
                        <label for="end_time"><?php esc_html_e('End Time', 'waza-booking'); ?></label>
                    </th>
                    <td>
                        <input type="time" id="end_time" name="end_time" required />
                    </td>
                </tr>
                
                <tr>
                    <th scope="row">
                        <label for="capacity"><?php esc_html_e('Capacity', 'waza-booking'); ?></label>
                    </th>
                    <td>
                        <input type="number" id="capacity" name="capacity" required 
                               min="1" max="1000" value="10" />
                        <p class="description">
                            <?php esc_html_e('Maximum number of participants for this slot.', 'waza-booking'); ?>
                        </p>
                    </td>
                </tr>
                
                <tr>
                    <th scope="row">
                        <label for="location"><?php esc_html_e('Location', 'waza-booking'); ?></label>
                    </th>
                    <td>
                        <input type="text" id="location" name="location" class="regular-text" />
                        <p class="description">
                            <?php esc_html_e('Specific location for this slot (optional).', 'waza-booking'); ?>
                        </p>
                    </td>
                </tr>
                
                <tr>
                    <th scope="row">
                        <label for="notes"><?php esc_html_e('Notes', 'waza-booking'); ?></label>
                    </th>
                    <td>
                        <textarea id="notes" name="notes" rows="3" class="large-text"></textarea>
                        <p class="description">
                            <?php esc_html_e('Additional notes or instructions for this slot.', 'waza-booking'); ?>
                        </p>
                    </td>
                </tr>
            </table>
            
            <p class="submit">
                <button type="submit" class="button button-primary">
                    <?php esc_html_e('Create Slot', 'waza-booking'); ?>
                </button>
                <a href="<?php echo esc_url(admin_url('admin.php?page=waza-slots')); ?>" class="button">
                    <?php esc_html_e('Cancel', 'waza-booking'); ?>
                </a>
            </p>
        </form>
        <?php
    }
    
    /**
     * Render bulk create form
     */
    private function render_bulk_create_form() {
        // Get activities
        $activities = get_posts([
            'post_type' => 'waza_activity',
            'post_status' => 'publish',
            'numberposts' => -1
        ]);
        
        ?>
        <form id="bulk-create-form" class="waza-form">
            <table class="form-table">
                <tr>
                    <th scope="row">
                        <label for="bulk_activity_id"><?php esc_html_e('Activity', 'waza-booking'); ?></label>
                    </th>
                    <td>
                        <select id="bulk_activity_id" name="activity_id" required>
                            <option value=""><?php esc_html_e('Select an activity', 'waza-booking'); ?></option>
                            <?php foreach ($activities as $activity): ?>
                                <option value="<?php echo esc_attr($activity->ID); ?>">
                                    <?php echo esc_html($activity->post_title); ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </td>
                </tr>
                
                <tr>
                    <th scope="row">
                        <label for="date_range_start"><?php esc_html_e('Date Range', 'waza-booking'); ?></label>
                    </th>
                    <td>
                        <input type="date" id="date_range_start" name="date_range_start" required 
                               min="<?php echo esc_attr(date('Y-m-d')); ?>" />
                        <span> <?php esc_html_e('to', 'waza-booking'); ?> </span>
                        <input type="date" id="date_range_end" name="date_range_end" required 
                               min="<?php echo esc_attr(date('Y-m-d')); ?>" />
                    </td>
                </tr>
                
                <tr>
                    <th scope="row">
                        <label><?php esc_html_e('Days of Week', 'waza-booking'); ?></label>
                    </th>
                    <td>
                        <fieldset>
                            <legend class="screen-reader-text">
                                <?php esc_html_e('Select days of the week', 'waza-booking'); ?>
                            </legend>
                            <?php
                            $days = [
                                'monday' => __('Monday', 'waza-booking'),
                                'tuesday' => __('Tuesday', 'waza-booking'),
                                'wednesday' => __('Wednesday', 'waza-booking'),
                                'thursday' => __('Thursday', 'waza-booking'),
                                'friday' => __('Friday', 'waza-booking'),
                                'saturday' => __('Saturday', 'waza-booking'),
                                'sunday' => __('Sunday', 'waza-booking')
                            ];
                            
                            foreach ($days as $key => $label):
                            ?>
                                <label style="display: inline-block; margin-right: 15px;">
                                    <input type="checkbox" name="days[]" value="<?php echo esc_attr($key); ?>" />
                                    <?php echo esc_html($label); ?>
                                </label>
                            <?php endforeach; ?>
                        </fieldset>
                    </td>
                </tr>
                
                <tr>
                    <th scope="row">
                        <label for="bulk_start_time"><?php esc_html_e('Time Slots', 'waza-booking'); ?></label>
                    </th>
                    <td>
                        <div id="time-slots-container">
                            <div class="time-slot-row">
                                <input type="time" name="time_slots[0][start]" required />
                                <span> - </span>
                                <input type="time" name="time_slots[0][end]" required />
                                <button type="button" class="button remove-time-slot" style="margin-left: 10px;">
                                    <?php esc_html_e('Remove', 'waza-booking'); ?>
                                </button>
                            </div>
                        </div>
                        <button type="button" id="add-time-slot" class="button">
                            <?php esc_html_e('Add Another Time Slot', 'waza-booking'); ?>
                        </button>
                    </td>
                </tr>
                
                <tr>
                    <th scope="row">
                        <label for="bulk_capacity"><?php esc_html_e('Capacity', 'waza-booking'); ?></label>
                    </th>
                    <td>
                        <input type="number" id="bulk_capacity" name="capacity" required 
                               min="1" max="1000" value="10" />
                    </td>
                </tr>
            </table>
            
            <p class="submit">
                <button type="submit" class="button button-primary">
                    <?php esc_html_e('Create Slots', 'waza-booking'); ?>
                </button>
                <a href="<?php echo esc_url(admin_url('admin.php?page=waza-slots')); ?>" class="button">
                    <?php esc_html_e('Cancel', 'waza-booking'); ?>
                </a>
            </p>
        </form>
        <?php
    }
    
    /**
     * Save slot via AJAX
     */
    public function save_slot() {
        check_ajax_referer('waza_slot_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_die(__('Insufficient permissions.', 'waza-booking'));
        }
        
        $activity_id = intval($_POST['activity_id']);
        $start_date = sanitize_text_field($_POST['start_date']);
        $start_time = sanitize_text_field($_POST['start_time']);
        $end_time = sanitize_text_field($_POST['end_time']);
        $capacity = intval($_POST['capacity']);
        $location = sanitize_text_field($_POST['location']);
        $notes = sanitize_textarea_field($_POST['notes']);
        
        if (!$activity_id || !$start_date || !$start_time || !$end_time) {
            wp_send_json_error(__('Please fill in all required fields.', 'waza-booking'));
        }
        
        global $wpdb;
        
        $start_datetime = $start_date . ' ' . $start_time . ':00';
        $end_datetime = $start_date . ' ' . $end_time . ':00';
        
        $result = $wpdb->insert(
            $wpdb->prefix . 'waza_slots',
            [
                'activity_id' => $activity_id,
                'start_datetime' => $start_datetime,
                'end_datetime' => $end_datetime,
                'capacity' => $capacity,
                'location' => $location,
                'notes' => $notes,
                'status' => 'available'
            ],
            ['%d', '%s', '%s', '%d', '%s', '%s', '%s']
        );
        
        if ($result) {
            wp_send_json_success([
                'message' => __('Slot created successfully!', 'waza-booking'),
                'slot_id' => $wpdb->insert_id
            ]);
        } else {
            wp_send_json_error(__('Failed to create slot. Please try again.', 'waza-booking'));
        }
    }
    
    /**
     * Delete slot via AJAX
     */
    public function delete_slot() {
        check_ajax_referer('waza_slot_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_die(__('Insufficient permissions.', 'waza-booking'));
        }
        
        $slot_id = intval($_POST['slot_id']);
        
        if (!$slot_id) {
            wp_send_json_error(__('Invalid slot ID.', 'waza-booking'));
        }
        
        global $wpdb;
        
        // Check if slot has bookings
        $booking_count = $wpdb->get_var($wpdb->prepare("
            SELECT COUNT(*) FROM {$wpdb->prefix}waza_bookings 
            WHERE slot_id = %d AND booking_status IN ('confirmed', 'pending')
        ", $slot_id));
        
        if ($booking_count > 0) {
            wp_send_json_error(__('Cannot delete slot with existing bookings.', 'waza-booking'));
        }
        
        $result = $wpdb->delete(
            $wpdb->prefix . 'waza_slots',
            ['id' => $slot_id],
            ['%d']
        );
        
        if ($result) {
            wp_send_json_success(__('Slot deleted successfully!', 'waza-booking'));
```
        
        ?>
        <form id="bulk-create-form" class="waza-form">
            <table class="form-table">
                <tr>
                    <th scope="row">
                        <label for="bulk_activity_id"><?php esc_html_e('Activity', 'waza-booking'); ?></label>
                    </th>
                    <td>
                        <select id="bulk_activity_id" name="activity_id" required>
                            <option value=""><?php esc_html_e('Select an activity', 'waza-booking'); ?></option>
                            <?php foreach ($activities as $activity): ?>
                                <option value="<?php echo esc_attr($activity->ID); ?>">
                                    <?php echo esc_html($activity->post_title); ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </td>
                </tr>
                
                <tr>
                    <th scope="row">
                        <label for="date_range_start"><?php esc_html_e('Date Range', 'waza-booking'); ?></label>
                    </th>
                    <td>
                        <input type="date" id="date_range_start" name="date_range_start" required 
                               min="<?php echo esc_attr(date('Y-m-d')); ?>" />
                        <span> <?php esc_html_e('to', 'waza-booking'); ?> </span>
                        <input type="date" id="date_range_end" name="date_range_end" required 
                               min="<?php echo esc_attr(date('Y-m-d')); ?>" />
                    </td>
                </tr>
                
                <tr>
                    <th scope="row">
                        <label><?php esc_html_e('Days of Week', 'waza-booking'); ?></label>
                    </th>
                    <td>
                        <fieldset>
                            <legend class="screen-reader-text">
                                <?php esc_html_e('Select days of the week', 'waza-booking'); ?>
                            </legend>
                            <?php
                            $days = [
                                'monday' => __('Monday', 'waza-booking'),
                                'tuesday' => __('Tuesday', 'waza-booking'),
                                'wednesday' => __('Wednesday', 'waza-booking'),
                                'thursday' => __('Thursday', 'waza-booking'),
                                'friday' => __('Friday', 'waza-booking'),
                                'saturday' => __('Saturday', 'waza-booking'),
                                'sunday' => __('Sunday', 'waza-booking')
                            ];
                            
                            foreach ($days as $key => $label):
                            ?>
                                <label style="display: inline-block; margin-right: 15px;">
                                    <input type="checkbox" name="days[]" value="<?php echo esc_attr($key); ?>" />
                                    <?php echo esc_html($label); ?>
                                </label>
                            <?php endforeach; ?>
                        </fieldset>
                    </td>
                </tr>
                
                <tr>
                    <th scope="row">
                        <label for="bulk_start_time"><?php esc_html_e('Time Slots', 'waza-booking'); ?></label>
                    </th>
                    <td>
                        <div id="time-slots-container">
                            <div class="time-slot-row">
                                <input type="time" name="time_slots[0][start]" required />
                                <span> - </span>
                                <input type="time" name="time_slots[0][end]" required />
                                <button type="button" class="button remove-time-slot" style="margin-left: 10px;">
                                    <?php esc_html_e('Remove', 'waza-booking'); ?>
                                </button>
                            </div>
                        </div>
                        <button type="button" id="add-time-slot" class="button">
                            <?php esc_html_e('Add Another Time Slot', 'waza-booking'); ?>
                        </button>
                    </td>
                </tr>
                
                <tr>
                    <th scope="row">
                        <label for="bulk_capacity"><?php esc_html_e('Capacity', 'waza-booking'); ?></label>
                    </th>
                    <td>
                        <input type="number" id="bulk_capacity" name="capacity" required 
                               min="1" max="1000" value="10" />
                    </td>
                </tr>
            </table>
            
            <p class="submit">
                <button type="submit" class="button button-primary">
                    <?php esc_html_e('Create Slots', 'waza-booking'); ?>
                </button>
                <a href="<?php echo esc_url(admin_url('admin.php?page=waza-slots')); ?>" class="button">
                    <?php esc_html_e('Cancel', 'waza-booking'); ?>
                </a>
            </p>
        </form>
        <?php
    }
    
    /**
     * Save slot via AJAX
     */
    public function save_slot() {
        check_ajax_referer('waza_slot_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_die(__('Insufficient permissions.', 'waza-booking'));
        }
        
        $activity_id = intval($_POST['activity_id']);
        $start_date = sanitize_text_field($_POST['start_date']);
        $start_time = sanitize_text_field($_POST['start_time']);
        $end_time = sanitize_text_field($_POST['end_time']);
        $capacity = intval($_POST['capacity']);
        $location = sanitize_text_field($_POST['location']);
        $notes = sanitize_textarea_field($_POST['notes']);
        
        if (!$activity_id || !$start_date || !$start_time || !$end_time) {
            wp_send_json_error(__('Please fill in all required fields.', 'waza-booking'));
        }
        
        global $wpdb;
        
        $start_datetime = $start_date . ' ' . $start_time . ':00';
        $end_datetime = $start_date . ' ' . $end_time . ':00';
        
        $result = $wpdb->insert(
            $wpdb->prefix . 'waza_slots',
            [
                'activity_id' => $activity_id,
                'start_datetime' => $start_datetime,
                'end_datetime' => $end_datetime,
                'capacity' => $capacity,
                'location' => $location,
                'notes' => $notes,
                'status' => 'available'
            ],
            ['%d', '%s', '%s', '%d', '%s', '%s', '%s']
        );
        
        if ($result) {
            wp_send_json_success([
                'message' => __('Slot created successfully!', 'waza-booking'),
                'slot_id' => $wpdb->insert_id
            ]);
        } else {
            wp_send_json_error(__('Failed to create slot. Please try again.', 'waza-booking'));
        }
    }
    
    /**
     * Delete slot via AJAX
     */
    public function delete_slot() {
        check_ajax_referer('waza_slot_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_die(__('Insufficient permissions.', 'waza-booking'));
        }
        
        $slot_id = intval($_POST['slot_id']);
        
        if (!$slot_id) {
            wp_send_json_error(__('Invalid slot ID.', 'waza-booking'));
        }
        
        global $wpdb;
        
        // Check if slot has bookings
        $booking_count = $wpdb->get_var($wpdb->prepare("
            SELECT COUNT(*) FROM {$wpdb->prefix}waza_bookings 
            WHERE slot_id = %d AND booking_status IN ('confirmed', 'pending')
        ", $slot_id));
        
        if ($booking_count > 0) {
            wp_send_json_error(__('Cannot delete slot with existing bookings.', 'waza-booking'));
        }
        
        $result = $wpdb->delete(
            $wpdb->prefix . 'waza_slots',
            ['id' => $slot_id],
            ['%d']
        );
        
        if ($result) {
            wp_send_json_success(__('Slot deleted successfully!', 'waza-booking'));
        } else {
            wp_send_json_error(__('Failed to delete slot.', 'waza-booking'));
        }
    }
    
    /**
     * Bulk create slots via AJAX
     */
    public function bulk_create_slots() {
        check_ajax_referer('waza_slot_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_die(__('Insufficient permissions.', 'waza-booking'));
        }
        
        $activity_id = intval($_POST['activity_id']);
        $start_date = sanitize_text_field($_POST['date_range_start']);
        $end_date = sanitize_text_field($_POST['date_range_end']);
        $days = array_map('sanitize_text_field', $_POST['days'] ?? []);
        $time_slots = $_POST['time_slots'] ?? [];
        $capacity = intval($_POST['capacity']);
        
        if (!$activity_id || !$start_date || !$end_date || empty($days) || empty($time_slots)) {
            wp_send_json_error(__('Please fill in all required fields.', 'waza-booking'));
        }
        
        global $wpdb;
        
        $created_count = 0;
        $current_date = strtotime($start_date);
        $end_timestamp = strtotime($end_date);
        
        $day_map = [
            'monday' => 1,
            'tuesday' => 2,
            'wednesday' => 3,
            'thursday' => 4,
            'friday' => 5,
            'saturday' => 6,
            'sunday' => 0
        ];
        
        while ($current_date <= $end_timestamp) {
            $day_of_week = date('w', $current_date);
            $day_name = array_search($day_of_week, $day_map);
            
            if (in_array($day_name, $days)) {
                $date_string = date('Y-m-d', $current_date);
                
                foreach ($time_slots as $time_slot) {
                    $start_time = sanitize_text_field($time_slot['start']);
                    $end_time = sanitize_text_field($time_slot['end']);
                    
                    if (!$start_time || !$end_time) continue;
                    
                    $start_datetime = $date_string . ' ' . $start_time . ':00';
                    $end_datetime = $date_string . ' ' . $end_time . ':00';
                    
                    $result = $wpdb->insert(
                        $wpdb->prefix . 'waza_slots',
                        [
                            'activity_id' => $activity_id,
                            'start_datetime' => $start_datetime,
                            'end_datetime' => $end_datetime,
                            'capacity' => $capacity,
                            'status' => 'available'
                        ],
                        ['%d', '%s', '%s', '%d', '%s']
                    );
                    
                    if ($result) {
                        $created_count++;
                    }
                }
            }
            
            $current_date = strtotime('+1 day', $current_date);
        }
        
        if ($created_count > 0) {
            wp_send_json_success([
                'message' => sprintf(
                    __('%d slots created successfully!', 'waza-booking'),
                    $created_count
                )
            ]);
        } else {
            wp_send_json_error(__('No slots were created. Please check your settings.', 'waza-booking'));
        }
    }
    
    /**
     * Get slot data via AJAX
     */
    public function get_slot() {
        check_ajax_referer('waza_slot_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_die(__('Insufficient permissions.', 'waza-booking'));
        }
        
        $slot_id = intval($_POST['slot_id']);
        
        if (!$slot_id) {
            wp_send_json_error(__('Invalid slot ID.', 'waza-booking'));
        }
        
        global $wpdb;
        
        $slot = $wpdb->get_row($wpdb->prepare(
            "SELECT s.*, p.post_title as activity_title
            FROM {$wpdb->prefix}waza_slots s
            LEFT JOIN {$wpdb->posts} p ON s.activity_id = p.ID
            WHERE s.id = %d",
            $slot_id
        ), ARRAY_A);
        
        if (!$slot) {
            wp_send_json_error(__('Slot not found.', 'waza-booking'));
        }
        
        // Format data for form
        $slot['start_date'] = date('Y-m-d', strtotime($slot['start_datetime']));
        $slot['start_time'] = date('H:i', strtotime($slot['start_datetime']));
        $slot['end_time'] = date('H:i', strtotime($slot['end_datetime']));
        
        wp_send_json_success($slot);
    }
    
    /**
     * Update slot via AJAX
     */
    public function update_slot() {
        check_ajax_referer('waza_slot_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_die(__('Insufficient permissions.', 'waza-booking'));
        }
        
        $slot_id = intval($_POST['slot_id']);
        $start_date = sanitize_text_field($_POST['start_date']);
        $start_time = sanitize_text_field($_POST['start_time']);
        $end_time = sanitize_text_field($_POST['end_time']);
        $capacity = intval($_POST['capacity']);
        $location = sanitize_text_field($_POST['location']);
        $notes = sanitize_textarea_field($_POST['notes']);
        
        if (!$slot_id || !$start_date || !$start_time || !$end_time) {
            wp_send_json_error(__('Please fill in all required fields.', 'waza-booking'));
        }
        
        global $wpdb;
        
        $start_datetime = $start_date . ' ' . $start_time . ':00';
        $end_datetime = $start_date . ' ' . $end_time . ':00';
        
        $result = $wpdb->update(
            $wpdb->prefix . 'waza_slots',
            [
                'start_datetime' => $start_datetime,
                'end_datetime' => $end_datetime,
                'capacity' => $capacity,
                'location' => $location,
                'notes' => $notes
            ],
            ['id' => $slot_id],
            ['%s', '%s', '%d', '%s', '%s'],
            ['%d']
        );
        
        if ($result !== false) {
            wp_send_json_success(__('Slot updated successfully!', 'waza-booking'));
        } else {
            wp_send_json_error(__('Failed to update slot. Please try again.', 'waza-booking'));
        }
    }
}
```